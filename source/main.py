# Imports from external packages
from absl import app
from absl import flags
import re

# Imports of internal packages
from documentation import logger
from information.networking import requests
from scraper import scraper

# Pattern to match, in order to check whether input is valid or not.
httpsPattern = r'https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)'

# Setup flags, so the user can set up required arguments
FLAGS = flags.FLAGS
flags.DEFINE_string("target", None, "[Required] The targets IP address. Has to be in the Regex Format of an IP, "
                                    "or it will fail",
                    required=True)
flags.DEFINE_string("logs", "../documentation/results.log", "Location for the result log. You can set a path for it, "
                                                            "or the default will be used.")

flags.DEFINE_bool("dvwa", False, "Setting this flag, will set the program to use the Damn Valuable Website App-Setup")


# checkFlags checks, whether all the necessary flags are set and will return true or false.
def checkFlags():
    if "localhost" in FLAGS.target:
        print("target defined as: %s!" % FLAGS.target)
        return True
    if FLAGS.target == "":
        print("No target was set, please try again")
        return False
    if not re.match(pattern=httpsPattern, string=FLAGS.target):
        print("The pattern did not match to the necessary Pattern. Please use something like:")
        print("1.) https://127.0.0.1")
        print("2.) https://www.test.de")
        return False
    print("target defined as: %s!" % FLAGS.target)
    return True


# main is the Main-Function that is the starting point of the program
def main(argv):
    if checkFlags():
        url = FLAGS.target
        logger.log("Initiating logs for testing the website running at %s" % url, "Initiation")
        reachable, information = requests.ping(url)
        if reachable:
            logger.log(information, "Ping Website")
            scraper.Login(url)
        else:
            logger.error("Ping Website", information)


if __name__ == "__main__":
    app.run(main)